<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Learnifly Education</title>
<!--Bootstrap Cdn Invoke-->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
	crossorigin="anonymous">

<!--FontAwesome CDN Invoke-->
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
	integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
	crossorigin="anonymous" referrerpolicy="no-referrer" />
	
	<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	
	
</head>

<body>
	<!--Header Start-->
	<div th:if="${sessionUser == null OR sessionUser ==''}">
		<div th:replace="~{fragments/navbar :: crm-header}"></div>
	</div>
	<div th:unless="${sessionUser == null OR sessionUser ==''}">
		<div th:replace="~{fragments/user-header :: u-header}"></div>
	</div>
	<!--Header End-->

	<!--Main Content Start-->
	<main class="container-fluid">
		<!--Banner invoke-->
		<section>
			<img src="Images/background.jpg" alt="Learnifly Education banner"
				width="100%">
		</section>
		<!--Content-->
		<section class="container py-5">
			<h5 class="text-center md-4">Our Courses</h5>
			<br>
			<!--courses-->
			<div class="row g-4 ">
				<!--Courses Start-->
				<div th:each="course : ${courseList}" class="col-lg-3 col-md-2">
					<!--Managing Card-->
					<div class="card shadow" style="width: 18rem;">
						<img th:src="@{${course.imageUrlString}}" class="card-img-top"
							alt="Spring Boot">
						<div class="card-body">
							<h5 class="card-title">
								<span th:text="${course.name}"></span>
							</h5>
							<p class="card-text">
								<span th:text="${course.description}"></span>
							</p>
							<ul class="list-group list-group-flush">
								<li class="list-group-item"><strong><i
										class="fa-solid fa-book"></i> Lectures:170</strong></li>
								<li class="list-group-item"><strong><i
										class="fa-solid fa-chart-line"></i>Rating : 4.5<i
										class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i
										class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i
										class="fa-solid fa-star-half"></i></strong></li>
								<li class="list-group-item"><strong><i
										class="fa-solid fa-money-check"></i> Price :</strong> <del
										th:text="${course.originalPrice}">Rs.8999</del> <span
									th:text="${course.discounted_price}" class="bg-light">Rs.3999</span></li>
								<li class="list-group-item">
									<div th:if="${sessionUser == null OR sessionUser ==''}">
										<a href="login" class="btn btn-outline-success">Login To
											Buy</a> <span class="bg-danger text-white p-1">56% off</span>
									</div>
									<div th:unless="${sessionUser == null OR sessionUser ==''}">
										<div th:if="${#lists.contains(purchasedCoursesNameList, course.name)}">
											<span class=text-success>Start learning.</span>
										</div>
										<div th:unless="${#lists.contains(purchasedCoursesNameList, course.name) }"> 
											<button class="btn btn-success"
												th:data-cname="${course.name}"
												th:data-camount="${course.discounted_price}"
												th:data-uname="${sessionUser.name}"
												th:data-uemail="${sessionUser.email}"
												th:data-uphoneno="${sessionUser.phoneno}"
												onclick="purchaseCourse(this.getAttribute('data-cname'), this.getAttribute('data-camount'), this.getAttribute('data-uname'), this.getAttribute('data-uemail'), this.getAttribute('data-uphoneno'))">
												Buy</button>
										</div>
									</div>
								</li>
							</ul>
						</div>
						<div class="card-footer text-body-secondary">
							Updated : <span th:text="${course.updatedOn}"></span>
						</div>
					</div>

				</div>
				<!--Courses End-->
			</div>
			<div class="col-lg-3 col-md-2">
				<!--Courses End-->
			</div>
		</section>
	</main>
	<!--Main Content End-->

	<!--Footer Start-->
	<div th:replace="~{fragments/footer :: crm-footer}"></div>
	<!--Footer End-->

	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
		crossorigin="anonymous">
</script>
<script>
	function purchaseCourse(courseName, courseAmount, uname, uemail,
			uphoneno) {
		var options = {
				"key" : "rzp_test_RGGOfmIFdS8a4R", // Enter the Key ID generated from the Dashboard
				"amount" : courseAmount * 100,
				"currency" : "INR",
				"name" : "Learnifly Education",
				"description" : "Course Transaction",
				"handler": function(response) {
				    console.log(response);
				    alert("Payment Successful");
				    
				    var date = new Date();
				    var dateOfPurchase = date.toLocaleDateString('en-GB')+", "+date.toLocaleTimeString('en-GB', {hour12: true})

				    var requestData = {
				        courseName: courseName,
				        amount: courseAmount,
				        userEmail: uemail,
				        dateOfPurchase:dateOfPurchase,
				        rzpPaymentId: response.razorpay_payment_id
				    };

				    $.ajax({
				        method: "POST",
				        url: "/api/storeOrderDetails",
				        contentType: "application/json",
				        data: JSON.stringify(requestData),
				        success: function(response) {
				            console.log("Data stored successfully", response);
				            alert("Congrats, Course has been added. Thank you!");
				            window.location.href = '/MyCourse';
				        },
				        error: function(jqXHR, textStatus, errorThrown) {
				            console.log("Error status:", textStatus);
				            console.log("Error thrown:", errorThrown);
				            console.log("Full response:", jqXHR.responseText);
				            alert("Some error occurred: " + errorThrown);
				        }
				    });
				},

				"prefill" : {
					"name" : uname,
					"email" : uemail,
					"contact" : uphoneno
				},
				"notes" : {
					"courseName" : courseName
				},
				"theme" : {
					"color" : "#3399cc"
				}
			};
			var rzp1 = new Razorpay(options);
			rzp1.on('payment.failed', function(response) {
				console.log(response);
			});
			rzp1.open();
		}
</script>
</body>

</html>